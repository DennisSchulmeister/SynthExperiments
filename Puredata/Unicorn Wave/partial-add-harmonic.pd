#N canvas 0 49 1920 1009 12;
#X obj 0 30 cnv 15 600 250 empty empty empty 20 12 0 14 #f5f5f5 #404040
0;
#X obj -30 -30 preset_hub k12 1 %hidden%;
#X text 10 40 \$1 must be the prefix to receive parameters \, e.g.
"p-p1-car1", f 82;
#X obj 700 100 inlet;
#X obj 700 1450 outlet;
#X text 10 80 \$3 must be the number of wavetables (e.g. 11 for 1/octave)
\, starting with one., f 82;
#X text 10 230 For all this to work \, the synthesizer must have loaded
the basic waveforms with the [wavetables/xx/wavetable-xx] objects.
, f 82;
#X obj 30 350 r \$1-enabled;
#X obj 130 350 r \$1-waveform;
#X obj 280 350 r \$1-volume;
#X obj 0 0 cnv 15 600 30 empty empty Addition\ of\ a\ single\ harmonic\ to\ the\ carrier\ or\ modulator\ wavetables
12 12 0 14 #e0e0e0 #404040 0;
#X text 30 320 ==== Detect parameter changes ====;
#X obj 30 500 s \$2-recalc;
#X obj 0 280 cnv 10 600 10 empty empty empty 20 12 0 14 #e0e0e0 #404040
0;
#X text 700 70 ==== Recalc wavetables ====;
#X text 10 60 \$2 must be the prefix of the wavetable arrays to which
the harmonic is added., f 82;
#X text 10 150 When a parameter change is detected \, a bang is sent
to \$2-recalc. You may delay this bang to throttle the recalcs and
then send it back to the inlet of the fist harmonic. Its outlet will
bang when the processing is done \, so that the harmonics can simply
be chained., f 82;
#X obj 700 150 trigger b b;
#X obj 730 190 ./utils/for-loop 1 \$3;
#X obj 780 610 symbol \$2;
#X text 890 190 Wavetable number;
#X text 10 100 \$4 must be the harmonic number \, starting from one.
, f 82;
#X obj 30 630 r \$1-enabled;
#X obj 140 630 r \$1-volume;
#X floatatom 30 660 5 0 0 0 - - - 0 0 1, f 5;
#X floatatom 140 660 5 0 0 0 - - - 0 0 1, f 5;
#X obj 140 690 trigger b f;
#X text 710 130 ---- Loop over each wavetable ----;
#X floatatom 30 440 5 0 0 0 - - - 0 0 1, f 5;
#X floatatom 130 440 5 0 0 0 - - - 0 0 1, f 5;
#X floatatom 280 440 5 0 0 0 - - - 0 0 1, f 5;
#X floatatom 30 749 5 0 0 0 - - - 0 0 1, f 5;
#X obj 130 380 trigger b f;
#X obj 780 860 select 0 1 2 3;
#X msg 780 890 symbol sin;
#X text 760 530 ---- Calculate target wavetable name ----;
#X msg 870 890 symbol saw;
#X msg 960 890 symbol square;
#X msg 1070 890 symbol triangle;
#X text 760 750 ---- Calculate source wavetable name ----;
#X obj 30 470 bang;
#X obj 780 830 value _\$0_waveform;
#X obj 130 410 value _\$0_waveform;
#X text 1410 830 Works because each source/target wavetable covers
one octave;
#X obj 750 770 trigger b b;
#X obj 780 920 pack s f, f 60;
#X obj 780 979 s \$0-source-wavetable;
#X obj 780 700 s \$0-target-wavetable;
#X obj 780 800 trigger b b;
#X text 760 1030 ---- Add harmonic waveform ----;
#X msg 840 1281 set \$1;
#X obj 770 1401 tabwrite;
#X obj 900 1401 r \$0-target-wavetable;
#X msg 1150 1281 set \$1;
#X obj 900 1281 r \$0-source-wavetable;
#X obj 1210 1281 r \$0-target-wavetable;
#X obj 870 1221 value _\$0_index1;
#X obj 800 1371 value _\$0_index1;
#X obj 770 1341 trigger f b;
#X obj 770 1221 trigger f f f;
#X text 10 120 \$5 must be the maximum allowed number of harmonics.
, f 82;
#X obj 770 1311 expr ($f1 / \$5 * _\$0_volume) + \\$f2;
#X obj 750 1080 expr size("$s1");
#X obj 890 1050 r \$0-target-wavetable;
#X obj 750 1050 symbol;
#X msg 810 1050 symbol \$1;
#X msg 750 1140 0 \$1;
#X obj 750 1191 ./utils/for-loop;
#X msg 780 950 symbol wavetable-\$1\$2;
#X msg 840 1401 set \$1;
#X obj 770 1251 expr ($f1 * \$4) % _\$0_size;
#X obj 750 1110 trigger f f;
#X obj 840 1110 value _\$0_size;
#X obj 30 779 value _\$0_volume;
#X text 30 600 ==== Calculate amplitude scaling factor ====;
#X msg 780 670 symbol \$1-\$2;
#X obj 780 640 pack s f, f 12;
#X obj 780 580 trigger b f, f 12;
#X obj 750 550 trigger b f f;
#X obj 850 550 value _\$0_index;
#X obj 1200 830 expr min(_\$0_index * \$4 \, \$3);
#X obj 80 470 bng 15 250 50 0 empty empty empty 17 7 0 10 #fcfcfc #000000
#000000 1;
#X text 1230 890 <-- Waveform types;
#X obj 30 720 expr \\$f1 * sqrt(sqrt($f2));
#X obj 780 390 samplerate~;
#X text 760 250 ---- Check Nyquist frequency ----;
#X obj 750 270 trigger f f;
#X obj 780 330 mtof;
#X text 1060 300 Max. MIDI note (fundamental frequency) of the wavetable
;
#X obj 750 480 spigot;
#X obj 780 300 expr (ceil(float(128) / \$3) * \\$f1) - 1;
#X obj 780 359 trigger b f, f 19;
#X obj 780 420 expr \\$f1 / 2 / \\$f2, f 19;
#X text 930 420 Max. allowed harmonic for the wavetable;
#X obj 780 449 >= \$4;
#X obj 750 220 trigger f;
#X obj 770 1281 tabread;
#X obj 1080 1281 tabread;
#X text 1380 1280 <--- tabread4?;
#X connect 3 0 17 0;
#X connect 7 0 28 0;
#X connect 8 0 32 0;
#X connect 9 0 30 0;
#X connect 17 0 4 0;
#X connect 17 1 18 0;
#X connect 18 0 95 0;
#X connect 19 0 76 0;
#X connect 22 0 24 0;
#X connect 23 0 25 0;
#X connect 24 0 83 0;
#X connect 25 0 26 0;
#X connect 26 0 83 0;
#X connect 26 1 83 1;
#X connect 28 0 40 0;
#X connect 29 0 40 0;
#X connect 30 0 40 0;
#X connect 31 0 73 0;
#X connect 32 0 42 0;
#X connect 32 1 42 0;
#X connect 33 0 34 0;
#X connect 33 1 36 0;
#X connect 33 2 37 0;
#X connect 33 3 38 0;
#X connect 34 0 45 0;
#X connect 36 0 45 0;
#X connect 37 0 45 0;
#X connect 38 0 45 0;
#X connect 40 0 12 0;
#X connect 41 0 33 0;
#X connect 42 0 29 0;
#X connect 44 0 64 0;
#X connect 44 1 48 0;
#X connect 45 0 68 0;
#X connect 48 0 41 0;
#X connect 48 1 80 0;
#X connect 50 0 96 0;
#X connect 52 0 69 0;
#X connect 53 0 97 0;
#X connect 54 0 50 0;
#X connect 55 0 53 0;
#X connect 57 0 51 1;
#X connect 58 0 51 0;
#X connect 58 1 57 0;
#X connect 59 0 70 0;
#X connect 59 1 97 0;
#X connect 59 2 56 0;
#X connect 61 0 58 0;
#X connect 62 0 71 0;
#X connect 63 0 65 0;
#X connect 64 0 62 0;
#X connect 65 0 64 1;
#X connect 66 0 67 0;
#X connect 67 0 59 0;
#X connect 68 0 46 0;
#X connect 69 0 51 0;
#X connect 70 0 96 0;
#X connect 71 0 66 0;
#X connect 71 1 72 0;
#X connect 75 0 47 0;
#X connect 76 0 75 0;
#X connect 77 0 19 0;
#X connect 77 1 76 1;
#X connect 78 0 44 0;
#X connect 78 1 77 0;
#X connect 78 2 79 0;
#X connect 80 0 45 1;
#X connect 81 0 12 0;
#X connect 83 0 31 0;
#X connect 84 0 92 0;
#X connect 86 0 89 0;
#X connect 86 1 90 0;
#X connect 87 0 91 0;
#X connect 89 0 78 0;
#X connect 90 0 87 0;
#X connect 91 0 84 0;
#X connect 91 1 92 1;
#X connect 92 0 94 0;
#X connect 94 0 89 1;
#X connect 95 0 86 0;
#X connect 96 0 61 0;
#X connect 97 0 61 1;
